/*
Deployment script for EcoTravelDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "EcoTravelDB"
:setvar DefaultFilePrefix "EcoTravelDB"
:setvar DefaultDataPath "C:\Users\c.kempinaire\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"
:setvar DefaultLogPath "C:\Users\c.kempinaire\AppData\Local\Microsoft\Microsoft SQL Server Local DB\Instances\MSSQLLocalDB\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 8192e086-73f9-40d0-8059-a8964a5e0605 is skipped, element [dbo].[Annulation].[Id] (SqlSimpleColumn) will not be renamed to IdAnnulation';


GO
PRINT N'Rename refactoring operation with key 397a0fca-b7e8-4fb0-9e8e-14d4af62fe2d, 7fd67f6b-1439-45f3-ade8-cf00c4cf0cfa is skipped, element [dbo].[Indisponibilite].[Id] (SqlSimpleColumn) will not be renamed to IdReservation';


GO
PRINT N'Rename refactoring operation with key 99cfcd29-68f0-4e78-8165-33d0b40d162d is skipped, element [dbo].[Indisponibilite].[Id] (SqlSimpleColumn) will not be renamed to IdIndisponibilite';


GO
PRINT N'Rename refactoring operation with key 085871ba-3192-4cab-a8dd-8e20a98fc45b is skipped, element [dbo].[Indisponibilite].[Id] (SqlSimpleColumn) will not be renamed to IdIndisponibilite';


GO
PRINT N'Rename refactoring operation with key c6b79e88-ad32-4a81-aa74-8150d255e001 is skipped, element [dbo].[Reservation].[Id] (SqlSimpleColumn) will not be renamed to IdReservation';


GO
PRINT N'Rename refactoring operation with key cb88dd29-2c1e-4ff0-9f6e-ef3d499f590e is skipped, element [dbo].[Client].[Id] (SqlSimpleColumn) will not be renamed to IdClient';


GO
PRINT N'Rename refactoring operation with key 9efb0d81-1af7-418c-b45d-a1eca745704a is skipped, element [dbo].[Logement].[Id] (SqlSimpleColumn) will not be renamed to IdLogement';


GO
PRINT N'Rename refactoring operation with key fd2f6f1a-888d-4f7d-b47b-091245c33aba is skipped, element [dbo].[Logement].[Rue] (SqlSimpleColumn) will not be renamed to rue';


GO
PRINT N'Rename refactoring operation with key 9c5e8173-dfd5-4b8e-8f0e-89166951faa0 is skipped, element [dbo].[Logement].[numeroRue] (SqlSimpleColumn) will not be renamed to numero';


GO
PRINT N'Rename refactoring operation with key f11c785d-750b-400c-b9cd-451844a51e65 is skipped, element [dbo].[Logement].[animaux] (SqlSimpleColumn) will not be renamed to animauxAdmis';


GO
PRINT N'Rename refactoring operation with key cac09d5b-f6f8-4c31-aac4-51214d3ba12b is skipped, element [dbo].[Type].[Id] (SqlSimpleColumn) will not be renamed to IdType';


GO
PRINT N'Rename refactoring operation with key b915ce2d-f819-4080-8f81-9e2900ee35f8 is skipped, element [dbo].[Annulation].[Id] (SqlSimpleColumn) will not be renamed to IdClient';


GO
PRINT N'Rename refactoring operation with key e9bae8a2-503d-4eac-8787-2c062c957480 is skipped, element [dbo].[Indisponibilite].[Id] (SqlSimpleColumn) will not be renamed to IdIndisponibilite';


GO
PRINT N'Rename refactoring operation with key 103cf4b9-70f5-47d9-98bb-446c0c7c9bd8 is skipped, element [dbo].[Indisponibilite].[datefin] (SqlSimpleColumn) will not be renamed to dateFin';


GO
PRINT N'Rename refactoring operation with key 5c2ce4dc-3987-42f6-a979-2b0db59adfee is skipped, element [dbo].[Reservation].[Id] (SqlSimpleColumn) will not be renamed to IdReservation';


GO
PRINT N'Rename refactoring operation with key b27e8271-d506-47f2-bb4f-5bdec53ac6a9 is skipped, element [dbo].[Avis].[Id] (SqlSimpleColumn) will not be renamed to IdAvis';


GO
PRINT N'Rename refactoring operation with key 782b1618-9a20-4223-8c19-1e62b1abb438 is skipped, element [dbo].[photos].[Id] (SqlSimpleColumn) will not be renamed to IdPhoto';


GO
PRINT N'Creating View [dbo].[BestLogement]...';


GO
CREATE VIEW [dbo].[BestLogement] 

AS SELECT L.*
FROM [Logement] AS L
JOIN [Avis] AS A 
ON L.[idLogement] = A.[idLogement]
GROUP BY L.[idLogement]
Having AVG(A.[note])>(SELECT AVG([note]) FROM [Avis]);
GO
PRINT N'Creating View [dbo].[ReservationPays]...';


GO
CREATE VIEW [dbo].[ReservationPays]
	AS SELECT [idReservation],
			  [dateDebut],
			  [dateFin],
			  L.[pays]
	FROM [Reservation] AS R
	JOIN [Logement] as L
	ON R.[idLogement] = L.[idLogement]
GO
PRINT N'Creating Procedure [dbo].[SP_ClientAdd]...';


GO
CREATE PROCEDURE [dbo].[SP_ClientAdd]
	@nom NVARCHAR(50),
	@prenom NVARCHAR(50),
	@email NVARCHAR(255),
	@pays NVARCHAR(50),
	@telephone NVARCHAR(50),
	@password NVARCHAR(32)

AS
	INSERT INTO [Client] ([nom],[prenom],[email], [pays], [telephone])
	OUTPUT [inserted].[idClient]
	VALUES (@nom, @prenom, @email, @pays, @telephone, HASHBYTES('SHA2_512',@password))
GO
PRINT N'Creating Procedure [dbo].[SP_ClientCheck]...';


GO
CREATE PROCEDURE [dbo].[SP_ClientCheck]
	@email NVARCHAR(255),
	@pass NVARCHAR(32)
AS
	SELECT [idClient]
	FROM [Client] 
	WHERE	[email] = @email 
		AND [password] = HASHBYTES('SHA2_512',@pass)
GO
PRINT N'Creating Procedure [dbo].[SP_Logement_Month]...';


GO
CREATE PROCEDURE [dbo].[SP_Logement_Month] AS
    SELECT * FROM [Logement]
    WHERE [DateCreation] BETWEEN CONVERT(DATETIME,DATEDIFF(DAY,30,GETDATE())) AND GETDATE()
GO
PRINT N'Creating Procedure [dbo].[SP_Reservations_Now]...';


GO
CREATE PROCEDURE [dbo].[SP_Reservations_Now]
    @id_client INT
AS
BEGIN
    SELECT L.*, R.[dateDebut], R.[dateFin]
    FROM [Logement] AS L
    JOIN [Reservation] AS R
    ON R.[idLogement] = L.[idLogement]
    JOIN [Annulation] AS A
    ON A.[idReservation] = R.[IdReservation]
    WHERE R.[dateDebut] >= GETDATE() 
    AND A.[dateAnnulation] IS NULL
    AND R.[idClient] = @id_client
END
GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'cb88dd29-2c1e-4ff0-9f6e-ef3d499f590e')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('cb88dd29-2c1e-4ff0-9f6e-ef3d499f590e')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9efb0d81-1af7-418c-b45d-a1eca745704a')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9efb0d81-1af7-418c-b45d-a1eca745704a')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'fd2f6f1a-888d-4f7d-b47b-091245c33aba')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('fd2f6f1a-888d-4f7d-b47b-091245c33aba')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9c5e8173-dfd5-4b8e-8f0e-89166951faa0')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9c5e8173-dfd5-4b8e-8f0e-89166951faa0')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f11c785d-750b-400c-b9cd-451844a51e65')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f11c785d-750b-400c-b9cd-451844a51e65')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'cac09d5b-f6f8-4c31-aac4-51214d3ba12b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('cac09d5b-f6f8-4c31-aac4-51214d3ba12b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '397a0fca-b7e8-4fb0-9e8e-14d4af62fe2d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('397a0fca-b7e8-4fb0-9e8e-14d4af62fe2d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '8192e086-73f9-40d0-8059-a8964a5e0605')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('8192e086-73f9-40d0-8059-a8964a5e0605')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'b915ce2d-f819-4080-8f81-9e2900ee35f8')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('b915ce2d-f819-4080-8f81-9e2900ee35f8')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c6b79e88-ad32-4a81-aa74-8150d255e001')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c6b79e88-ad32-4a81-aa74-8150d255e001')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '7fd67f6b-1439-45f3-ade8-cf00c4cf0cfa')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('7fd67f6b-1439-45f3-ade8-cf00c4cf0cfa')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '99cfcd29-68f0-4e78-8165-33d0b40d162d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('99cfcd29-68f0-4e78-8165-33d0b40d162d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '085871ba-3192-4cab-a8dd-8e20a98fc45b')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('085871ba-3192-4cab-a8dd-8e20a98fc45b')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e9bae8a2-503d-4eac-8787-2c062c957480')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e9bae8a2-503d-4eac-8787-2c062c957480')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '103cf4b9-70f5-47d9-98bb-446c0c7c9bd8')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('103cf4b9-70f5-47d9-98bb-446c0c7c9bd8')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '5c2ce4dc-3987-42f6-a979-2b0db59adfee')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('5c2ce4dc-3987-42f6-a979-2b0db59adfee')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'b27e8271-d506-47f2-bb4f-5bdec53ac6a9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('b27e8271-d506-47f2-bb4f-5bdec53ac6a9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '782b1618-9a20-4223-8c19-1e62b1abb438')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('782b1618-9a20-4223-8c19-1e62b1abb438')

GO

GO
PRINT N'Update complete.';


GO
